/*!
 * js模拟系统select v1.0
 * http://www.cnblogs.com/typeof/ 
 * 
 * 主流浏览器对html的select元素渲染都不一样，IE系列(6, 7, 8)也不一样，
 * firefox，chrome，safari，opera 渲染和事件处理也稍有差异
 * 该脚本解决了在不同浏览器下渲染和事件响应不一致的问题，对系统select是完全
 * 意义上的替换。v1.0版本只支持单个select选择即不支持二级或者三级联动且不支持系统select的onchange事件。
 * 该版本支持模拟select选择的数据和系统select选中数据的同步，不影响form表单的提交 
 *
 * 如果page上select有的不想通过该脚本替换，只想维持系统select，可以在相应的select元素添加自定义属性data-enabled="true"，
 * 否则可以在想要通过该脚本替换的select元素上添加自定义属性data-enabled="false"或者不加，会默认为这个select需要
 * 通过该脚本进行替换
 *
 * 日期：2012-11-07 15:38
 */
(function(a){function b(){this.init()}b.prototype={constructor:b,init:function(d){var c=a.getElementsByTagName("select",d);this.globalEvent();this.initView(c)},initView:function(c){var e=0,g,f=c.length,d;for(;e<f;e++){g=c[e];d=g.getAttribute("data-enabled");if(!d||d==="true"){continue}if(a.isVisible(g)){g.style.display="none"}this.create(g)}},create:function(u){var x=[],s=0,e,n,d,q,k,j,c,l,g,t,r,m,o,h,w,f,p,v;d=u.getElementsByTagName("option");e=d.length;for(;s<e;s++){n=d[s];q=n.value;k=n.innerText||n.textContent;j={value:q,text:k};if(n.selected){m=q;r=k;j.selected=true}x.push(j)}c=this.render(this.tmpl,x);l='<ul class="select-item">'+c+"</ul>";o=document.createElement("span");o.style.display="none";o.className="select-wrapper";g=document.createElement("span");g.className="select-default unselectable";g.unselectable="on";g.setAttribute("tabindex","1");g.setAttribute("data-value",m);g.setAttribute("hidefocus",true);g.innerHTML=r;o.appendChild(g);t=document.createElement("i");t.className="select-icon";o.appendChild(t);h=document.createElement("span");h.className="select-list hide";h.innerHTML=l;o.appendChild(h);u.parentNode.insertBefore(o,null);u.style.display="block";this.sysEvent(o);w=a.position(u);u.style.display="none";f=w.left;p=w.top;v=" display: inline-block;";o.style.cssText=v},globalEvent:function(){var g,d,f,h,c,e=this;a.on(document,"click",function(i){g=i.target,d=g.className;switch(d){case"select-icon":case"select-default unselectable":f=g.tagName.toLowerCase()==="span"?g:g.previousSibling;h=f.nextSibling.nextSibling;if(i.button===0){e.initSelected(f);if(a.isHidden(h)){c="inline-block";e.closeSelect()}else{c="none"}h.style.display=c;f.focus()}else{if(i.button===2){h.style.display="none"}}e.zIndex(h);break;case"select-option":case"select-option selected":if(i.button===0){e.fireSelected(g,g.parentNode.parentNode.previousSibling.previousSibling);h.style.display="none"}break;default:while(g&&g.nodeType!==9){if(g.nodeType===1){if(g.className==="select-wrapper"){return}}g=g.parentNode}e.closeSelect();break}})},sysEvent:function(e){var f=e.firstChild,i=e.lastChild,g,c=/chrome/i.test(navigator.userAgent),h=c?"keypress":"keyup",d=this;a.on(e,"mouseover",function(j){if(!d.doScrolling){g=j.target;d.activate(g)}});a.on(e,"mouseout",function(j){if(!d.doScrolling){g=j.target;d.deactivate(g)}});a.on(f,"keydown",function(j){var k=j.keyCode;switch(k){case 13:d.enter(i);break;case 38:d.doScrolling=true;d.up(i);break;case 40:d.doScrolling=true;d.down(i);break;default:break}});a.on(f,h,function(j){var k=j.keyCode;switch(k){case 13:d.doScrolling=false;break;case 38:d.doScrolling=false;break;case 40:d.doScrolling=false;break;default:break}})},zIndex:function(e){var c=10,f=e.parentNode.parentNode,d=a.next(f);if(d){f.style.zIndex=c;d.style.zIndex=--c}},initSelected:function(e){var m=e.innerText||e.textContent,g=e.getAttribute("data-value"),c=e.nextSibling.nextSibling,d=c.firstChild.firstChild,l,k,f,h=0,j,i=false;for(;d;d=d.nextSibling){l=d.innerText||d.textContent;k=d.getAttribute("data-value");if(m===l&&g===k){if(a.isHidden(c)){c.style.display="block";i=true}j=c.scrollHeight;if(d.offsetTop>(j/2)){if(c.clientHeight+c.scrollTop===j){f="up"}else{f="down"}}else{if(c.scrollTop===h){f="down"}else{f="up"}}this.inView(d,c,f);if(i){c.style.display="none"}this.activate(d);break}}},activate:function(g){var c=(g.tagName||"").toLowerCase(),e=g.className,d=g.parentNode,h=d.firstChild,f=d.lastChild;switch(c){case"li":if(!~e.indexOf("selected")&&(g!==h||g!==f)){this.deactivate(g);g.className=e+" selected"}break;default:break}},deactivate:function(h){var e=(h.tagName||"").toLowerCase(),f=(" "+h.className+" ").replace(/[\n\r\t]/,"");switch(e){case"li":var d=0,c=a.siblings(h),g=c.length,j;for(;d<g;d++){j=c[d];j.className=a.trim(f.replace(" selected ",""))}break;default:break}},fireSelected:function(e,c){var g=e.innerText||e.textContent,f=e.getAttribute("data-value"),d;c.setAttribute("data-value",f);if(c.innerText){c.innerText=g}else{c.textContent=g}d=c.parentNode.previousSibling.previousSibling;d.value=f;d.setAttribute("data-text",g)},closeSelect:function(){var c=a.getElementsByClassName("select-list"),d=0,f=c.length,e;for(;d<f;d++){e=c[d];if(a.isVisible(e)){e.style.display="none"}}},up:function(g){var f=g.firstChild,d=f.childNodes,c=this.getSelectedIndex(d),h,e=c.index;if(e>0){e--;h=d[e];this.inView(h,g,"up");this.activate(h);this.fireSelected(h,g.previousSibling.previousSibling)}},down:function(g){var f=g.firstChild,d=f.childNodes,c=this.getSelectedIndex(d),h,e=c.index;if(e<d.length-1){e++;h=d[e];this.inView(h,g,"down");this.activate(h);this.fireSelected(h,g.previousSibling.previousSibling)}},enter:function(g){var f=g.firstChild,d=f.childNodes,c,e,h;c=this.getSelectedIndex(d);e=c.index;h=d[e];this.fireSelected(h,g.previousSibling.previousSibling);this.closeSelect()},getSelectedIndex:function(c){var d=0,f=c.length,e;for(;d<f;d++){e=c[d];if(~e.className.indexOf("selected")){return{index:d}}}return{index:-1}},inView:function(f,i,d){var h=i.scrollTop,e=f.offsetTop,g;if(d==="up"){if(e===0){i.scrollTop=e}else{if(e<h){g=e-h;this.scrollInView(i,g)}}}else{var c=i.clientHeight;if(e+f.offsetHeight===i.scrollHeight){i.scrollTop=i.scrollHeight-i.clientHeight}else{if(e+f.offsetHeight>c+h){g=(e+f.offsetHeight)-(h+c);this.scrollInView(i,g)}}}},scrollInView:function(c,d){setTimeout(function(){c.scrollTop+=d},10)},doScrolling:false,render:function(h,f){var g=0,k,e=f.length,d,j,l,c=[];for(;g<e;g++){k=f[g];l=h.replace(/\{\{\w+\}\}/g,function(i){d=i.replace(/[\{\}]+/g,"");j=k[d]||"";if(d==="class"){j+="select-option";if(k.selected){j+=" selected"}}return j});c.push(l)}return c.join("")},tmpl:'<li class="{{class}}" data-value="{{value}}">{{text}}</li>'};a.swing.jselect=function(){return new b()}})(squid);