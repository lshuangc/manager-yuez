requirejs.config({baseUrl:"../../dist",paths:{jquery:"../examples/image-upload/jquery"}});require(["webuploader.flashonly"],function(a){$(function(){var n=$("#uploader"),i=$('<ul class="filelist"></ul>').appendTo(n.find(".queueList")),s=n.find(".statusBar"),d=s.find(".info"),c=n.find(".uploadBtn"),g=n.find(".placeholder"),m=s.find(".progress").hide(),u=0,l=0,j=window.devicePixelRatio||1,k=110*j,b=110*j,h="pedding",v={},q=(function(){var w=document.createElement("p").style,x="transition" in w||"WebkitTransition" in w||"MozTransition" in w||"msTransition" in w||"OTransition" in w;w=null;return x})(),p;p=a.create({pick:{id:"#filePicker",label:"点击选择图片"},dnd:"#dndArea",paste:"#uploader",swf:"../../dist/Uploader.swf",chunked:true,sendAsBinary:true,server:"../../server/fileupload.php",fileNumLimit:300,fileSizeLimit:200*1024*1024,fileSingleSizeLimit:50*1024*1024});p.addButton({id:"#filePicker2",label:"继续添加"});function r(B){var C=$('<li id="'+B.id+'"><p class="title">'+B.name+'</p><p class="imgWrap"></p><p class="progress"><span></span></p></li>'),z=$('<div class="file-panel"><span class="cancel">删除</span><span class="rotateRight">向右旋转</span><span class="rotateLeft">向左旋转</span></div>').appendTo(C),y=C.find("p.progress span"),x=C.find("p.imgWrap"),A=$('<p class="error"></p>'),w=function(D){switch(D){case"exceed_size":text="文件大小超出";break;case"interrupt":text="上传暂停";break;default:text="上传失败，请重试";break}A.text(text).appendTo(C)};if(B.getStatus()==="invalid"){w(B.statusText)}else{x.text("预览中");p.makeThumb(B,function(E,F){if(E){x.text("不能预览");return}var D=$('<img src="'+F+'">');x.empty().append(D)},k,b);v[B.id]=[B.size,0];B.rotation=0}B.on("statuschange",function(E,D){if(D==="progress"){y.hide().width(0)}else{if(D==="queued"){C.off("mouseenter mouseleave");z.remove()}}if(E==="error"||E==="invalid"){console.log(B.statusText);w(B.statusText);v[B.id][1]=1}else{if(E==="interrupt"){w("interrupt")}else{if(E==="queued"){v[B.id][1]=0}else{if(E==="progress"){A.remove();y.css("display","block")}else{if(E==="complete"){C.append('<span class="success"></span>')}}}}}C.removeClass("state-"+D).addClass("state-"+E)});C.on("mouseenter",function(){z.stop().animate({height:30})});C.on("mouseleave",function(){z.stop().animate({height:0})});z.on("click","span",function(){var D=$(this).index(),E;switch(D){case 0:p.removeFile(B);return;case 1:B.rotation+=90;break;case 2:B.rotation-=90;break}if(q){E="rotate("+B.rotation+"deg)";x.css({"-webkit-transform":E,"-mos-transform":E,"-o-transform":E,transform:E})}else{x.css("filter","progid:DXImageTransform.Microsoft.BasicImage(rotation="+(~~((B.rotation/90)%4+4)%4)+")")}});C.appendTo(i)}function t(w){var x=$("#"+w.id);delete v[w.id];e();x.off().find(".file-panel").off().end().remove()}function e(){var w=0,z=0,x=m.children(),y;$.each(v,function(B,A){z+=A[0];w+=A[0]*A[1]});y=z?w/z:0;x.eq(0).text(Math.round(y*100)+"%");x.eq(1).css("width",Math.round(y*100)+"%");f()}function f(){var x="",w;if(h==="ready"){x="选中"+u+"张图片，共"+a.formatSize(l)+"。"}else{if(h==="confirm"){w=p.getStats();if(w.uploadFailNum){x="已成功上传"+w.successNum+"张照片至XX相册，"+w.uploadFailNum+'张照片上传失败，<a class="retry" href="#">重新上传</a>失败图片或<a class="ignore" href="#">忽略</a>'}}else{w=p.getStats();x="共"+u+"张（"+a.formatSize(l)+"），已上传"+w.successNum+"张";if(w.uploadFailNum){x+="，失败"+w.uploadFailNum+"张"}}}d.html(x)}function o(y){var x,w;if(y===h){return}c.removeClass("state-"+h);c.addClass("state-"+y);h=y;switch(h){case"pedding":g.removeClass("element-invisible");i.hide();s.addClass("element-invisible");p.refresh();break;case"ready":g.addClass("element-invisible");$("#filePicker2").removeClass("element-invisible");i.show();s.removeClass("element-invisible");p.refresh();break;case"uploading":$("#filePicker2").addClass("element-invisible");m.show();c.text("暂停上传");break;case"paused":m.show();c.text("继续上传");break;case"confirm":m.hide();c.text("开始上传").addClass("disabled");w=p.getStats();if(w.successNum&&!w.uploadFailNum){o("finish");return}break;case"finish":w=p.getStats();if(w.successNum){alert("上传成功")}else{h="done";location.reload()}break}f()}p.onUploadProgress=function(y,w){var z=$("#"+y.id),x=z.find(".progress span");x.css("width",w*100+"%");v[y.id][1]=w;e()};p.onFileQueued=function(w){u++;l+=w.size;if(u===1){g.addClass("element-invisible");s.show()}r(w);o("ready");e()};p.onFileDequeued=function(w){u--;l-=w.size;if(!u){o("pedding")}t(w);e()};p.on("all",function(x){var w;switch(x){case"uploadFinished":o("confirm");break;case"startUpload":o("uploading");break;case"stopUpload":o("paused");break}});p.onError=function(w){alert("Eroor: "+w)};c.on("click",function(){if($(this).hasClass("disabled")){return false}if(h==="ready"){p.upload()}else{if(h==="paused"){p.upload()}else{if(h==="uploading"){p.stop()}}}});d.on("click",".retry",function(){p.retry()});d.on("click",".ignore",function(){alert("todo")});c.addClass("state-"+h);e()})});